# CarnotCycles.jl

[![Build Status](https://github.com/Sush1090/CoolPropCycles.jl/actions/workflows/CI.yml/badge.svg?branch=main)](https://github.com/Sush1090/CoolPropCycles.jl/actions/workflows/CI.yml?query=branch%3Amain)

[![Dev](https://img.shields.io/badge/docs-dev-blue.svg)](https://sush1090.github.io/CarnotCycles.jl/dev/)

This package combines [ModelingToolkit.jl](https://github.com/SciML/ModelingToolkit.jl) "Acausal Modeling" with [CoolProp.jl](https://github.com/CoolProp/CoolProp.jl) and [Clapyeron.jl](https://github.com/ClapeyronThermo/Clapeyron.jl) to model thermodynamic cycles:

1. Organic Rakine Cycle
2. Vapour Compression Cycle
3. Brayton Cycle

It is for steady state calculations, hence the evaporators and compressors are modeled using energy conservation. The principle is state-point manipulations.  One can also make custom cycles based on different processes.

It is extendible as users can add their own component in the following manner 

```julia
function MyComp(type::abc;name,...)
    @named inport = CoolantPort()
    @named outport = CoolantPort()
    para = @parameters begin
        MyParas ...
    end
    vars = @variables begin
        MyVars ...
     end
   eqs = [  outport.mdot ~ abs(inport.mdot) 
            outport.p ~ eq1 ...
            outport.h ~ eq2 ...
            ..
   ]
   compose(ODESystem(eqs, t, vars, para;name), inport, outport)
end
```

The `CoolantPort()` is fixed for the pressure `p`, enthalpy `h`, and mass flow rate `mdot`. The mass flow rate of the system is conserved through the system. 


It provides the following components:

1. Compressor using Isentropic, Isothermal and Isochoric processes
2. Expander using Isentropic, Isothermal and Isochoric processes
3. Isenthalpic Valve 
4. Evaporator
5. Condensor
6. Heat Source - Temperature independent
<!-- 7. Recuperator for the ORC
8. Three-faced valve based on mass flow rate spliting -->

 <!-- It also provides basic functions that find the pressure to match the pitch points.  -->
## Installation

In the Julia prompt, first type `]` and then:

```julia
pkg> add CarnotCycles
```

For the developer version type:
```julia
pkg> add https://github.com/Sush1090/CarnotCycles.jl.git
```

## Basic Usage
Every default component has the following variables : `P(t)`,`s_in(t)`,`p_in(t)`,`T_in(t)`,`h_in(t)`,`ρ_in(t)`,`s_out(t)`,`p_out(t)`,`T_out(t)`,`h_out(t)`,`ρ_out(t)` and two ports `inport` and `outport`. 
Follow the [ModelingToolkit.jl](https://github.com/SciML/ModelingToolkit.jl) documentation for more details on variable handling. 

Note: sign convention: Power supplied to the system is +ve while power generated by the system is -ve.

## Examples 
### Organic Rankine Cycle
Example of Organic Rankine Cycle using Clapeyron.jl two-component fluid. 

```julia
using CarnotCycles, ModelingToolkit, DifferentialEquations, CoolProp
model = cPR(["Pentane","toluene"],idealmodel = ReidIdeal)
load_fluid(model)
@independent_variables t
start_T = 300;
start_p = 101325
start_mdot = 40 #g/s
x_ = 0.9
z_ = CarnotCycles.mass_to_moles(model,[x_,1 - x_],start_mdot)
start_h = enthalpy(model,start_p,start_T,z_)


@named source = MassSource()
@named compressor = Pump()
@named evap = CarnotCycles.SimpleEvaporator()
@named expander = CarnotCycles.IsentropicExpander()
@named sink = MassSink()

eqs = [
    connect(source.port,compressor.inport)
    connect(compressor.outport,evap.inport)
    connect(evap.outport,expander.inport)
    connect(expander.outport,sink.port)
]
systems = [source,compressor,evap,expander,sink]
@named test_isentropic = ODESystem(eqs, t, systems=systems)
u0 = []
para = [source.source_pressure=>start_p, source.source_enthalpy => start_h,source.source_mdot => start_mdot,compressor.πc => 7.0,compressor.η => 0.7,source.source_x => x_,
        expander.η => 0.9, expander.πc => compressor.πc, evap.ΔT_sh => 6]
sys = structural_simplify(test_isentropic)
prob = SteadyStateProblem(sys,u0,para)
sol = solve(prob)

η_cycle = (sol[expander.P] - sol[compressor.P])/sol[evap.Qdot]
```


## Phase Diagram Plotting

As of now the direct plotting of T-S and P-H phase diagram of the cycle is provided. It requires the `systems` to have the first as `MassSource(...)` and last variable as `MassSink(...)`.   
```julia
PhasePlot(PhasePlotType_TS(),sol,systems,fluid)
```
```julia
PhasePlot(PhasePlotType_PH(),sol,systems,fluid)
```
![Pressure-Enthalpy Cycle Diagram](https://github.com/Sush1090/CarnotCycles.jl/tree/main/Images/PH_orc.svg)

![Temperature-Entropy Cycle Diagram](https://github.com/Sush1090/CarnotCycles.jl/tree/main/Images/TS_orc.svg)

## Thermodynamic Cycle Optimization
The cycles created can be wrapped with functions and sent to optimization routines. Most of the optimal solutions of purely theromodynamic systems lie at the boundary of constrains or saturation curve. Hence the initial box of constrain chosen has to be robust enough to have decent volume of feasible solutions.

The most trusted algorithms for thermodynamic optimizations are Genetic Algorithms. It is well integrated with
[Optimization.jl](https://docs.sciml.ai/Optimization/stable/) and [Metaheuristics.jl](https://github.com/jmejia8/Metaheuristics.jl)
 
Usage Framework 

```julia
ORC(x,p) = ...
using Optimization, OptimizationMetaheuristics

x0 = [...]
p = [...]
f = OptimizationFunction(ORC)
prob = Optimization.OptimizationProblem(f, x0, p, lb = [...], ub = [...])
sol = solve(prob, PSO(), maxiters = 100000, maxtime = 100.0)
```
The thing to note here is that the `lb` and `ub` given to the optimizer has to be in limits such that the internal functions of CoolProp are computable. 

A working example is in [Examples\OptimizationExample.jl](https://github.com/Sush1090/CoolPropCycles.jl/blob/main/Examples/OptimizationExample.jl)
